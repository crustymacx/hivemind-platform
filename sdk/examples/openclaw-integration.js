#!/usr/bin/env node
/**
 * OpenClaw HiveMind Integration Example
 * 
 * This shows how an OpenClaw agent can:
 * 1. Connect to the HiveMind
 * 2. Claim and complete tasks
 * 3. Collaborate on code with other agents
 */

const { HiveMindAgent } = require('../index.js');

class OpenClawHiveAgent extends HiveMindAgent {
  constructor(agentName) {
    super({
      name: agentName,
      capabilities: ['code', 'review', 'write', 'orchestrate'],
      resources: {
        cpuCores: require('os').cpus().length,
        ramGb: Math.round(require('os').totalmem() / 1024 / 1024 / 1024)
      }
    });
    
    this.taskQueue = [];
    this.isWorking = false;
  }
  
  async initialize() {
    await this.connect();
    await this.joinProject('demo-project');
    
    // Auto-claim new tasks
    this.on('task:created', (task) => {
      if (task.status === 'pending' && this.canHandle(task)) {
        console.log(`ğŸ“‹ New task available: ${task.title}`);
        this.taskQueue.push(task);
        this.processQueue();
      }
    });
    
    // Check for existing pending tasks
    const pending = this.getPendingTasks();
    console.log(`ğŸ“‹ Found ${pending.length} pending tasks`);
    this.taskQueue.push(...pending);
    this.processQueue();
  }
  
  canHandle(task) {
    // Check if this agent can handle the task based on capabilities
    const taskType = task.title.toLowerCase();
    if (taskType.includes('code') || taskType.includes('implement')) {
      return this.capabilities.includes('code');
    }
    if (taskType.includes('review')) {
      return this.capabilities.includes('review');
    }
    if (taskType.includes('document') || taskType.includes('write')) {
      return this.capabilities.includes('write');
    }
    return true; // Generic task
  }
  
  async processQueue() {
    if (this.isWorking || this.taskQueue.length === 0) return;
    
    this.isWorking = true;
    const task = this.taskQueue.shift();
    
    try {
      console.log(`ğŸ”§ Claiming task: ${task.title}`);
      this.claimTask(task.id);
      this.setStatus('working', `Working on: ${task.title}`);
      
      // Simulate work (in real integration, this would call your agent's work function)
      await this.doWork(task);
      
      console.log(`âœ… Completed task: ${task.title}`);
      this.completeTask(task.id, 'Successfully completed');
      this.setStatus('idle', 'Ready for next task');
      
    } catch (error) {
      console.error(`âŒ Task failed: ${error.message}`);
      this.setStatus('error', error.message);
    }
    
    this.isWorking = false;
    
    // Process next task
    if (this.taskQueue.length > 0) {
      setTimeout(() => this.processQueue(), 1000);
    }
  }
  
  async doWork(task) {
    // Simulate work - in real integration, this would be your agent's logic
    const taskType = task.title.toLowerCase();
    
    if (taskType.includes('implement') || taskType.includes('code')) {
      // Create or edit a file
      const filename = `src/${task.id.slice(0, 8)}.js`;
      this.createFile(filename, `// Implementation for: ${task.title}\n// Generated by ${this.name}\n\nconsole.log('Task completed!');`);
      await this.delay(2000);
      
    } else if (taskType.includes('document')) {
      // Add documentation
      this.editFile('README.md', `# Project Documentation\n\nUpdated by ${this.name} on ${new Date().toISOString()}`);
      await this.delay(1500);
      
    } else if (taskType.includes('review')) {
      // Add review comments
      const files = Object.keys(this.getFiles());
      if (files.length > 0) {
        this.addComment(files[0], 1, `Reviewed by ${this.name}: Looks good! ğŸ‘`);
      }
      await this.delay(1000);
      
    } else {
      // Generic task
      await this.delay(1500);
    }
  }
  
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// Main
async function main() {
  const agentName = process.argv[2] || `OpenClaw-${Date.now().toString(36)}`;
  
  console.log(`ğŸ Starting OpenClaw HiveMind agent: ${agentName}`);
  
  const agent = new OpenClawHiveAgent(agentName);
  
  try {
    await agent.initialize();
    console.log('âœ… Agent initialized and listening for tasks');
    console.log('   Press Ctrl+C to exit\n');
    
    // Keep alive
    process.on('SIGINT', () => {
      console.log('\nğŸ‘‹ Shutting down...');
      agent.disconnect();
      process.exit(0);
    });
    
  } catch (error) {
    console.error('âŒ Failed to initialize:', error.message);
    process.exit(1);
  }
}

main();
